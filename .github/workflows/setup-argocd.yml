name: ArgoCD Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'install'
        type: choice
        options:
          - install
          - uninstall

env:
  ARGOCD_VERSION: v3.1.9
  ARGOCD_NAMESPACE: argocd

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Verify cluster connectivity
        run: kubectl cluster-info

      - name: Create required namespaces
        run: |
          kubectl create namespace $ARGOCD_NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace expensy --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          kubectl create namespace ingress-nginx --dry-run=client -o yaml | kubectl apply -f -

      - name: Create application secrets
        run: |
          kubectl -n expensy create secret generic expensy-secrets \
            --from-literal=DATABASE_URI='${{ secrets.DATABASE_URI }}' \
            --from-literal=REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}' \
            --from-literal=MONGO_INITDB_ROOT_USERNAME='${{ secrets.MONGO_INITDB_ROOT_USERNAME }}' \
            --from-literal=MONGO_INITDB_ROOT_PASSWORD='${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Check if ArgoCD is installed
        id: check-argocd
        run: |
          if kubectl get deployment argocd-server -n $ARGOCD_NAMESPACE >/dev/null 2>&1; then
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install ArgoCD
        if: steps.check-argocd.outputs.installed == 'false' && github.event.inputs.action == 'install'
        run: |
          echo "Installing ArgoCD $ARGOCD_VERSION..."
          kubectl apply -n $ARGOCD_NAMESPACE -f https://raw.githubusercontent.com/argoproj/argo-cd/$ARGOCD_VERSION/manifests/install.yaml
          
          echo "Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=available deployment/argocd-server -n $ARGOCD_NAMESPACE --timeout=600s
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n $ARGOCD_NAMESPACE --timeout=600s

      - name: Install ArgoCD CLI
        if: github.event.inputs.action == 'install'
        run: |
          echo "Installing ArgoCD CLI..."
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/download/$ARGOCD_VERSION/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64
          argocd version --client

      - name: Setup ArgoCD port-forward and login
        if: github.event.inputs.action == 'install'
        id: argocd-login
        run: |
          echo "Setting up port-forward to ArgoCD server..."
          kubectl port-forward svc/argocd-server -n $ARGOCD_NAMESPACE 8080:443 >/dev/null 2>&1 &
          echo "portforward_pid=$!" >> $GITHUB_OUTPUT
          
          # Wait for port-forward to be ready
          for i in {1..20}; do
            if curl -sk https://localhost:8080 >/dev/null 2>&1; then
              echo "Port-forward is ready"
              break
            fi
            echo "Waiting for port-forward... ($i/20)"
            sleep 3
          done
          
          # Get initial admin password
          PASSWORD=$(kubectl -n $ARGOCD_NAMESPACE get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "::add-mask::$PASSWORD"
          
          # Login to ArgoCD
          echo "Logging in to ArgoCD..."
          for i in {1..10}; do
            if argocd login localhost:8080 --username admin --password "$PASSWORD" --insecure; then
              echo "Successfully logged in to ArgoCD"
              break
            fi
            echo "Retrying ArgoCD login ($i/10)..."
            sleep 5
          done

      - name: Configure private GitHub repository in ArgoCD
        if: github.event.inputs.action == 'install'
        run: |
          echo "Configuring private repository access..."
          argocd repo add https://github.com/${{ github.repository }}.git \
            --username ${{ github.actor }} \
            --password ${{ secrets.GH_PAT }} \
            --insecure-skip-server-verification
          
          echo "✅ Repository configured successfully"
          argocd repo list

      - name: Configure ArgoCD to manage applications
        if: github.event.inputs.action == 'install'
        run: |
          echo "Applying ArgoCD application manifests..."
          kubectl apply -f kubernetes/argocd.yaml
          
          echo "Syncing applications..."
          argocd app sync expensy-app --timeout 600 --retry-limit 3 || true
          argocd app sync monitoring-prometheus --timeout 600 --retry-limit 3 || true
          argocd app sync monitoring-loki --timeout 600 --retry-limit 3 || true
          argocd app sync ingress-nginx --timeout 600 --retry-limit 3 || true
          argocd app sync argocd-ui --timeout 600 --retry-limit 3 || true
          
          echo "✅ ArgoCD is now managing all applications!"
          echo "ArgoCD will automatically:"
          echo "  - Deploy and manage Expensy app (frontend, backend, MongoDB, Redis)"
          echo "  - Deploy Prometheus & Grafana for monitoring"
          echo "  - Deploy Loki for log aggregation"
          echo "  - Deploy NGINX Ingress Controller"
          echo "  - Deploy ArgoCD UI with subpath support"
          echo "  - Auto-sync changes from Git"
          echo "  - Self-heal any manual changes"

      - name: Get ArgoCD admin password
        if: steps.check-argocd.outputs.installed == 'false' && github.event.inputs.action == 'install'
        run: |
          echo "Getting ArgoCD admin password..."
          PASSWORD=$(kubectl -n $ARGOCD_NAMESPACE get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "::add-mask::$PASSWORD"
          echo "ARGOCD_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo ""
          echo "=========================================="
          echo "ArgoCD Setup Complete!"
          echo "=========================================="
          echo "Username: admin"
          echo "Password: (stored in argocd-initial-admin-secret)"
          echo ""
          echo "To access ArgoCD UI:"
          echo "1. Via Ingress: https://final.naseroish.com/argocd"
          echo "2. Via port-forward: kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "   Then visit: https://localhost:8080"

      - name: Cleanup port-forward
        if: always() && github.event.inputs.action == 'install'
        run: |
          if [ -n "${{ steps.argocd-login.outputs.portforward_pid }}" ]; then
            kill ${{ steps.argocd-login.outputs.portforward_pid }} 2>/dev/null || true
          fi

      - name: Uninstall ArgoCD
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "Removing ArgoCD applications..."
          kubectl delete -f kubernetes/argocd.yaml --ignore-not-found=true
          
          echo "Waiting for applications to be removed..."
          sleep 30
          
          echo "Uninstalling ArgoCD..."
          kubectl delete -n $ARGOCD_NAMESPACE -f https://raw.githubusercontent.com/argoproj/argo-cd/$ARGOCD_VERSION/manifests/install.yaml --ignore-not-found=true
          
          echo "Removing ArgoCD namespace..."
          kubectl delete namespace $ARGOCD_NAMESPACE --ignore-not-found=true
          
          echo "✅ ArgoCD has been uninstalled"

