name: Deploy to Cloud Provider

on:
  workflow_dispatch:
    inputs:
      cloud_provider:
        description: 'Cloud Provider'
        required: true
        type: choice
        options:
          - digitalocean
          - azure
          - aws
          - gcp
        default: 'digitalocean'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - destroy
          - destroy-all
        default: 'deploy'
      terraform_workspace:
        description: 'Terraform workspace (environment)'
        required: false
        default: 'production'

env:
  TF_VERSION: '1.9.0'

jobs:
  deploy:
    name: Deploy Infrastructure on ${{ github.event.inputs.cloud_provider }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ==================== DigitalOcean Setup ====================
      - name: Setup DigitalOcean CLI
        if: github.event.inputs.cloud_provider == 'digitalocean'
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Setup DigitalOcean Terraform Backend
        if: github.event.inputs.cloud_provider == 'digitalocean'
        run: |
          echo "Setting up DigitalOcean Spaces for Terraform state..."
          export AWS_ACCESS_KEY_ID=${{ secrets.DO_SPACES_ACCESS_KEY }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.DO_SPACES_SECRET_KEY }}

      # ==================== Azure Setup ====================
      - name: Azure Login
        if: github.event.inputs.cloud_provider == 'azure'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ==================== AWS Setup ====================
      - name: Configure AWS Credentials
        if: github.event.inputs.cloud_provider == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      # ==================== GCP Setup ====================
      - name: Authenticate to Google Cloud
        if: github.event.inputs.cloud_provider == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ==================== Terraform Setup ====================
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Cache Terraform state for local backend
      - name: Cache Terraform State
        uses: actions/cache@v3
        with:
          path: terraform/${{ github.event.inputs.cloud_provider }}/terraform.tfstate*
          key: terraform-${{ github.event.inputs.cloud_provider }}-${{ github.event.inputs.terraform_workspace }}-${{ hashFiles('terraform/${{ github.event.inputs.cloud_provider }}/**/*.tf') }}
          restore-keys: |
            terraform-${{ github.event.inputs.cloud_provider }}-${{ github.event.inputs.terraform_workspace }}-

      - name: Terraform Init
        working-directory: terraform/${{ github.event.inputs.cloud_provider }}
        run: |
          terraform init
          terraform workspace select ${{ github.event.inputs.terraform_workspace }} || terraform workspace new ${{ github.event.inputs.terraform_workspace }}
        env:
          # Cloud provider tokens
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        if: github.event.inputs.action == 'deploy'
        working-directory: terraform/${{ github.event.inputs.cloud_provider }}
        run: terraform plan -out=tfplan
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Terraform Apply
        if: github.event.inputs.action == 'deploy'
        working-directory: terraform/${{ github.event.inputs.cloud_provider }}
        run: terraform apply -auto-approve tfplan
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: terraform/${{ github.event.inputs.cloud_provider }}
        run: terraform destroy -auto-approve
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Clean Up Existing Resources (DigitalOcean)
        if: github.event.inputs.action == 'destroy-all' && github.event.inputs.cloud_provider == 'digitalocean'
        run: |
          echo "ðŸ§¹ Cleaning up ALL DigitalOcean resources for project: ${{ github.event.inputs.terraform_workspace }}"
          
          # Delete Kubernetes clusters
          echo "Deleting Kubernetes clusters..."
          doctl kubernetes cluster list --format ID,Name --no-header | grep "expensy" | awk '{print $1}' | xargs -r -I {} doctl kubernetes cluster delete {} --force || true
          
          # Wait for cluster deletion to complete
          sleep 10
          
          # Delete load balancers
          echo "Deleting load balancers..."
          doctl compute load-balancer list --format ID,Name --no-header | grep "expensy" | awk '{print $1}' | xargs -r -I {} doctl compute load-balancer delete {} --force || true
          
          # Delete firewalls
          echo "Deleting firewalls..."
          doctl compute firewall list --format ID,Name --no-header | grep "expensy" | awk '{print $1}' | xargs -r -I {} doctl compute firewall delete {} --force || true
          
          # Delete VPCs (skip default VPCs)
          echo "Deleting VPCs..."
          doctl vpcs list --format ID,Name,Default --no-header | grep "expensy" | grep -v "true" | awk '{print $1}' | xargs -r -I {} doctl vpcs delete {} --force || true
          
          # Delete container registry (WARNING: This deletes all images!)
          echo "Deleting container registry..."
          doctl registry delete --force || true
          
          # Clean up terraform state files and directories
          echo "Cleaning up Terraform state..."
          rm -rf terraform/${{ github.event.inputs.cloud_provider }}/terraform.tfstate*
          rm -rf terraform/${{ github.event.inputs.cloud_provider }}/.terraform
          
          echo "âœ… Cleanup complete! You can now run 'deploy' action."
        env:
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      
      # Save Terraform state back to cache
      - name: Upload Terraform State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-${{ github.event.inputs.cloud_provider }}-${{ github.event.inputs.terraform_workspace }}
          path: terraform/${{ github.event.inputs.cloud_provider }}/terraform.tfstate*
          retention-days: 30

      # ==================== Get Kubeconfig ====================
      - name: Get DigitalOcean Kubeconfig
        if: github.event.inputs.cloud_provider == 'digitalocean' && github.event.inputs.action == 'deploy'
        run: |
          doctl kubernetes cluster kubeconfig save $(terraform -chdir=terraform/digitalocean output -raw cluster_name)
          kubectl cluster-info

      - name: Get Azure AKS Kubeconfig
        if: github.event.inputs.cloud_provider == 'azure' && github.event.inputs.action == 'deploy'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name $(terraform -chdir=terraform/azure output -raw cluster_name) \
            --overwrite-existing
          kubectl cluster-info

      # ==================== Update Kubernetes Storage Class ====================
      - name: Update Kubernetes manifests for cloud provider
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "Updating storage class configuration for ${{ github.event.inputs.cloud_provider }}..."
          
          # Apply appropriate storage class
          if [ "${{ github.event.inputs.cloud_provider }}" == "digitalocean" ]; then
            kubectl apply -f kubernetes/storageclass-digitalocean.yaml || true
          elif [ "${{ github.event.inputs.cloud_provider }}" == "azure" ]; then
            kubectl apply -f kubernetes/storageclass-azure.yaml || true
          fi
          
          echo "âœ… Storage class configured"

      # ==================== Deploy ArgoCD ====================
      - name: Trigger ArgoCD Setup
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "Infrastructure deployed! Next steps:"
          echo "1. Run the 'ArgoCD Setup' workflow to install ArgoCD"
          echo "2. ArgoCD will automatically deploy all applications"
          echo ""
          echo "Cluster Information:"
          kubectl get nodes
          echo ""
          echo "Available Storage Classes:"
          kubectl get storageclass

      # ==================== Output Information ====================
      - name: Display Deployment Info
        if: github.event.inputs.action == 'deploy'
        working-directory: terraform/${{ github.event.inputs.cloud_provider }}
        run: |
          echo "=========================================="
          echo "Deployment Complete!"
          echo "=========================================="
          echo "Cloud Provider: ${{ github.event.inputs.cloud_provider }}"
          echo ""
          terraform output
